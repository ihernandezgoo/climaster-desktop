using System.ComponentModel;
using System.Runtime.CompilerServices;

namespace climaster.Models;

public class WidgetSettings : INotifyPropertyChanged
{
    private double _latitude = 43.31;
    private double _longitude = -1.98;
    private int _refreshInterval = 30; // minutuak
    private double _widgetOpacity = 1.0; // 100%
    private double _widgetScale = 1.0;
    private bool _showHourlyForecast = true;
    private bool _showDailyForecast = true;
    private string _locationName = "Donostia";
    private bool _useCurrentLocation = false;
    private List<Location> _recentLocations = new List<Location>();
    private double _widgetLeft = 1570; // Posición por defecto: derecha
    private double _widgetTop = 0; // Posición por defecto: arriba

    public double WidgetLeft 
    { 
        get => _widgetLeft;
        set 
        { 
            if (Math.Abs(_widgetLeft - value) > 0.1)
            {
                _widgetLeft = value;
                OnPropertyChanged();
            }
        }
    }

    public double WidgetTop 
    { 
        get => _widgetTop;
        set 
        { 
            if (Math.Abs(_widgetTop - value) > 0.1)
            {
                _widgetTop = value;
                OnPropertyChanged();
            }
        }
    }

    public double Latitude
    {
        get => _latitude;
        set { _latitude = value; OnPropertyChanged(); }
    }

    public double Longitude
    {
        get => _longitude;
        set { _longitude = value; OnPropertyChanged(); }
    }

    public int RefreshInterval
    {
        get => _refreshInterval;
        set { _refreshInterval = value; OnPropertyChanged(); }
    }

    public double WidgetOpacity
    {
        get => _widgetOpacity;
        set { _widgetOpacity = value; OnPropertyChanged(); }
    }

    public double WidgetScale
    {
        get => _widgetScale;
        set { _widgetScale = value; OnPropertyChanged(); }
    }

    public bool ShowHourlyForecast
    {
        get => _showHourlyForecast;
        set { _showHourlyForecast = value; OnPropertyChanged(); }
    }

    public bool ShowDailyForecast
    {
        get => _showDailyForecast;
        set { _showDailyForecast = value; OnPropertyChanged(); }
    }

    public string LocationName
    {
        get => _locationName;
        set { _locationName = value; OnPropertyChanged(); }
    }

    public bool UseCurrentLocation
    {
        get => _useCurrentLocation;
        set { _useCurrentLocation = value; OnPropertyChanged(); }
    }

    public List<Location> RecentLocations
    {
        get => _recentLocations;
        set { _recentLocations = value; OnPropertyChanged(); }
    }

    public event PropertyChangedEventHandler? PropertyChanged;

    protected void OnPropertyChanged([CallerMemberName] string? propertyName = null)
    {
        PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
    }

    public void AddRecentLocation(Location location)
    {
        var existing = _recentLocations.FirstOrDefault(l => 
            l.Name == location.Name && 
            Math.Abs(l.Latitude - location.Latitude) < 0.01 && 
            Math.Abs(l.Longitude - location.Longitude) < 0.01);
        
        if (existing != null)
        {
            _recentLocations.Remove(existing);
        }

        location.LastUsed = DateTime.Now;
        location.IsPredefined = false;
        _recentLocations.Insert(0, location);

        if (_recentLocations.Count > 5)
        {
            _recentLocations = _recentLocations.Take(10).ToList();
        }

        OnPropertyChanged(nameof(RecentLocations));
    }
}
